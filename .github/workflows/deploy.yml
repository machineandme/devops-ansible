name: Deliver
on:
  release:
    types: [published]
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      ANSIBLE_HOST_KEY_CHECKING: "False"
    steps:
      - uses: actions/checkout@v2
        with:
          token: '${{ secrets.PAT2 }}'
          submodules: recursive

      - name: Write ssh key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH }}" > ~/.ssh/id_rsa
          echo "${{ secrets.SSH_PUB }}" > ~/.ssh/id_rsa.pub
          chmod 600 ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa.pub

      - name: Install datadog role ansible from galaxy
        run: ansible-galaxy install datadog.datadog

      - name: Ansible datadog
        run: ansible-playbook playbooks/datadog.yaml

      - name: Ansible cache redis
        run: ansible-playbook playbooks/cache/redis.yaml

      - name: Ansible machines upload
        run: ansible-playbook playbooks/machines/upload.yaml

      - name: Ansible machines shirts
        run: ansible-playbook playbooks/machines/shirts.yaml

      - name: Build ticker
        run: ./build.sh
        working-directory: ./data/ticker/

      - name: Ansible machines ticker
        run: ansible-playbook playbooks/machines/ticker.yaml

      - name: Ansible machines caddy
        run: ansible-playbook playbooks/machines/caddy.yaml